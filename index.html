<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tic-Tac-Toe</title>
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.7.3/core.css" />
  <script type="module" src="https://pyscript.net/releases/2025.7.3/core.js"></script>
  <style>
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 5px;
    }
    .cell {
      width: 100px;
      height: 100px;
      font-size: 32px;
      text-align: center;
      line-height: 100px;
      border: 1px solid #000;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Tic-Tac-Toe</h1>
    <h2 id="status">Select an Option Below:</h2>
    <div id="mode-box">
      <select id="mode-select">
        <option value="">---Select Mode---</option>
        <option value="pvp">Play against a friend</option>
        <option value="pvc">Play against a CPU</option>
        <option value="scoreboard">See scoreboard</option>
      </select>
      <button id="start-button">Start Game</button>
    </div>
    <div id="player-box">
      <input type="text" id="playerX" placeholder="Enter Player X Name" style="display:none;">
      <input type="text" id="playerO" placeholder="Enter Player O Name" style="display:none;">
      <button id="submit-player-button" style="display:none;">Submit</button>
    </div>
    <div id="xo-select-box" style="display:none;">
      <button id="x-button">X</button>
      <button id="o-button">O</button>
    </div>
    <button id="play-again-button" style="display:none;">Play Again</button>
    <div id="scoreboard-box" style="display:none;">
      <h3 id="score-list"></h3>
      <button id="back-button">Back</button>
    </div>
    <div id="board">
      <button class="cell" id="cell-0"></button>
      <button class="cell" id="cell-1"></button>
      <button class="cell" id="cell-2"></button>
      <button class="cell" id="cell-3"></button>
      <button class="cell" id="cell-4"></button>
      <button class="cell" id="cell-5"></button>
      <button class="cell" id="cell-6"></button>
      <button class="cell" id="cell-7"></button>
      <button class="cell" id="cell-8"></button>
    </div>
  <script type="py">
    from pyscript import display, when
    from js import document
    import random

    board = [""] * 9
    saved_players = {}
    current_player = "X"
    playerX = None
    playerO = None
    game_over = False
    game_started = False
    is_pvp = True
    cpu_is_x = False

    class Player:
      def __init__(self, name):
        self.name = name
        self.x_score = 0
        self.o_score = 0
        self.draw_count = 0

      def add_xpoint(self):
        self.x_score += 1

      def add_opoint(self):
        self.o_score += 1

      def add_draw(self):
        self.draw_count += 1

      def get_tscore(self):
        return self.x_score + self.o_score
    
    def clear_board():
      global board, current_player, game_over, game_started

      board = [""] * 9
      current_player = "X"
      game_over = False
      game_started = False

      cells = document.getElementsByClassName("cell")
      for i in range(cells.length):
        cells[i].innerText = ""
    
    @when("click", "#back-button")
    def back_mode_select():
      document.getElementById("scoreboard-box").style.display = "none"
      document.getElementById("status").innerText = "Select an Option Below:"
      document.getElementById("mode-box").style.display = "block"
      document.getElementById("board").style.display = "grid"

    def get_ordinal(n):
      if 10 <= n % 100 <= 20:
        suffix = "th"
      else:
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(n % 10, "th")
      return f"{n}{suffix}"
    
    def show_scoreboard():
      document.getElementById("status").innerText = "Scoreboard:"
      document.getElementById("mode-box").style.display = "none"
      document.getElementById("board").style.display = "none"
      document.getElementById("scoreboard-box").style.display = "block"

      if len(saved_players) > 1:
        sorted_players = list(saved_players.values())
        for i in range(len(sorted_players) - 1):
          for j in range(len(sorted_players) - i - 1):
            if Player.get_tscore(sorted_players[j]) < Player.get_tscore(sorted_players[j + 1]):
              sorted_players[j], sorted_players[j + 1] = sorted_players[j + 1], sorted_players[j]
        # call and clear score list element
        score_list = document.getElementById("score-list")
        while score_list.firstChild:
          score_list.removeChild(score_list.firstChild)
        # appends and displays player scores
        place = 1
        for player in sorted_players:
          player_score = document.createElement("pre")
          player_score.innerText = (
            f"{get_ordinal(place)} - {player.name}: {player.x_score + player.o_score} point(s)\n"
            f"    {player.x_score} point(s) playing as X\n"
            f"    {player.o_score} point(s) playing as O\n"
            f"    {player.draw_count} draw(s)!\n"
          )
          score_list.appendChild(player_score)
          place += 1
      else:
        document.getElementById("score-list").innerText = "No players to display"
      
    @when("click", "#play-again-button")
    def play_again():
      clear_board()
      document.getElementById("play-again-button").style.display = "none"
      document.getElementById("status").innerText = "Select an Option Below:"
      document.getElementById("mode-box").style.display = "block"

    def cpu_move():
      global board, current_player, playerX, playerO
      status = document.getElementById("status")

      empty_indices = [i for i, cell in enumerate(board) if cell == ""]
      if not empty_indices:
        return
      
      choice = random.choice(empty_indices)
      cell_button = document.getElementById(f"cell-{choice}")
      cell_button.click()

    @when("click", "#board button")
    def handle_click(event):
      global board, current_player, game_over, game_started, is_pvp, cpu_is_x

      status = document.getElementById("status")

      if not game_started:
        return

      if game_over:
        return

      cell_id = int(event.target.id.split("-")[1])
      if board[cell_id] != "":
        return

      board[cell_id] = current_player
      event.target.innerText = current_player

      winner = check_win()
      if winner:
        game_over = True
        cpu_is_x = False
        document.getElementById("play-again-button").style.display = "block"
        if winner == "Draw":
          status.innerText = "It's a draw!"
          Player.add_draw(playerX)
          Player.add_draw(playerO)
        elif winner == "X":
          status.innerText = f"{playerX.name} wins!"
          Player.add_xpoint(playerX)
        else:
          status.innerText = f"{playerO.name} wins!"
          Player.add_opoint(playerO)
      else:
        if current_player == "X":
          status.innerText = f"{playerO.name}'s turn"
          current_player = "O"
          if not is_pvp and not cpu_is_x:
            cpu_move()
            if game_over:
              return
            status.innerText = f"{playerX.name}'s turn"
            current_player = "X"
        else:
          status.innerText = f"{playerX.name}'s turn"
          current_player = "X"
          if not is_pvp and cpu_is_x:
            cpu_move()
            if game_over:
              return
            status.innerText = f"{playerO.name}'s turn"
            current_player = "O"

    def check_win():
      win_conditions = [
        [0, 1, 2],
        [3, 4, 5],
        [6, 7, 8],
        [0, 3, 6],
        [1, 4, 7],
        [2, 5, 8],
        [0, 4, 8],
        [2, 4, 6]
      ]

      for a, b, c in win_conditions:
        if board[a] == board[b] == board[c] and board[a] in ('X', 'O'):
          return board[a]

      if "" not in board:
        return "Draw"

      return None
    
    def prompt_pvp():
      document.getElementById("status").innerText = "Enter Your Usernames:"
      document.getElementById("mode-box").style.display = "none"
      document.getElementById("player-box").style.display = "block"
      document.getElementById("playerX").style.display = "inline"
      document.getElementById("playerO").style.display = "inline"
      document.getElementById("submit-player-button").style.display = "block"
    
    @when("click", "#submit-player-button")
    def save_players(event):
      global game_started, current_player, playerX, playerO, is_pvp, cpu_is_x
      mode = document.getElementById("mode-select").value

      if is_pvp:
        nameX = document.getElementById("playerX").value
        nameO = document.getElementById("playerO").value
      else:
        if cpu_is_x:
          nameX = "CPU"
          nameO = document.getElementById("playerO").value
        else:
          nameX = document.getElementById("playerX").value
          nameO = "CPU"
      
      if not 2 <= len(nameX) <= 32:
        document.getElementById("status").innerText = "Username X must be between 2 and 32 characters."
        return
      if not 2 <= len(nameO) <= 32:
        document.getElementById("status").innerText = "Username O must be between 2 and 32 characters."
        return

      if nameX in saved_players:
        playerX = saved_players[nameX]
      else:
        playerX = Player(nameX)
        saved_players[nameX] = playerX
    
      if nameO in saved_players:
        playerO = saved_players[nameO]
      else:
        playerO = Player(nameO)
        saved_players[nameO] = playerO

      game_started = True
      document.getElementById("player-box").style.display = "none"
      if cpu_is_x:
        cpu_move()
        current_player = "O"
        document.getElementById("status").innerText = f"{playerO.name}'s turn"
      else:
        document.getElementById("status").innerText = f"{playerX.name}'s turn"

    def prompt_pvc():
      document.getElementById("status").innerText = "Select to play as 'X' or 'O'"
      document.getElementById("mode-box").style.display = "none"
      document.getElementById("xo-select-box").style.display = "block"

    @when("click", "#x-button")
    def pvc_x(event):
      global cpu_is_x
      cpu_is_x = False
      document.getElementById("status").innerText = "Enter Your Username:"
      document.getElementById("xo-select-box").style.display = "none"
      document.getElementById("player-box").style.display = "block"
      document.getElementById("playerX").style.display = "inline"
      document.getElementById("playerO").style.display = "none"
      document.getElementById("submit-player-button").style.display = "block"

    @when("click", "#o-button")
    def pvc_o(event):
      global cpu_is_x
      cpu_is_x = True
      document.getElementById("status").innerText = "Enter Your Username:"
      document.getElementById("xo-select-box").style.display = "none"
      document.getElementById("player-box").style.display = "block"
      document.getElementById("playerX").style.display = "none"
      document.getElementById("playerO").style.display = "inline"
      document.getElementById("submit-player-button").style.display = "block"

    @when("click", "#start-button")
    def start_game(event):
      global game_started, is_pvp
      mode = document.getElementById("mode-select").value
      
      if mode == "pvp":
        is_pvp = True
        prompt_pvp()
      elif mode == "pvc":
        is_pvp = False
        prompt_pvc()
      elif mode == "scoreboard":
        show_scoreboard()
      else:
        document.getElementById("status").innerText = "Please Select a Valid Mode:"
        return

</script>
</body>
</html>